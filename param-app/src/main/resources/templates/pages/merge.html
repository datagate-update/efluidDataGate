<!DOCTYPE html>
<html layout:decorate="~{layouts/pages.html}">
<head>
</head>
<body>
	<span layout:fragment="content">
		<span th:if="${preparation.status.name()}=='FAILED'">
			<div class="alert alert-danger">
				<h4>L'analyse des lots pendant l'import a rencontré une erreur</h4>
				<div th:replace="layouts/commons::error-display (${preparation.errorDuringPreparation.error},${preparation.errorDuringPreparation.payload})">...</div>
				<span class="remark">
					La préparation implique une extraction de toutes les données des tables identifiées comme du paramétrage dans le dictionnaire. 
					En cas de soucis sur ces données, le processus peut ne pas aboutir. Pour recommencer, importer à nouveau le fichier 
					Si nécessaire, merci de communiquer le code d'erreur suivant : <span th:text="|${preparation.errorDuringPreparation.error}-${preparation.errorDuringPreparation.timestamp}|">JSON_WRITE_ERROR-12414421224112</span>
				</span>
			</div>
			<a href="index.html" class="btn btn-secondary btn-sm" th:href="@{/ui/}">Revenir à la page d'accueil</a>
			<a th:href="@{/ui/pull}" href="#" class="btn btn-dark btn-sm">Retourner à l'import</a>
		</span>
		<form th:if="${preparation.status.name()}!='FAILED'" action="/merge.html" th:action="@{/ui/merge/commit}" method="post">
			<span th:if="${not needsAction}">
				<div class="alert alert-secondary">
					<h4>L'import n'a révélé aucune différence par rapport aux données actuelles</h4>
					<span class="remark">
						La totalité des modifications présentes dans le lot importé sont déjà en place dans la base de donnée actuelle. 
						Valider le lot n'apportera donc pas de changements, mais reste nécessaire pour éviter une comparaison de données
						 inutile lors des prochains imports.
					</span>
				</div>
			</span>
			<span th:if="${not preparation.emptyDiff}">
				<p>
					<h5>Ensemble des modifications identifiées
						<div class="float-right">
							<div th:if="${needsAction}" class="btn-group" role="group">
								<button type="button" id="selectAllButton" class="btn btn-outline-primary btn-sm">Tout appliquer</button>
								<button type="button" id="rollbackAllButton"  class="btn btn-outline-danger btn-sm">Tout ignorer</button>
							</div>&nbsp;
							<div class="btn-group" role="group">
								<button type="button" id="closeAllButton" class="btn btn-outline-warning btn-sm">Tout réduire</button>
								<button type="button" id="showAllButton" class="btn btn-outline-info btn-sm">Tout afficher</button>
							</div>&nbsp;
							<a th:href="@{/ui/merge/cancel}" href="#" class="btn btn-secondary btn-sm">Abandonner</a>
							<a th:if="!${showAll}" th:href="@{/ui/merge?showAll=true}" href="/merge?showAll=true" class="btn btn-dark btn-sm">Afficher les égalités</a>
							<a th:if="${showAll}" th:href="@{/ui/merge?showAll=false}" href="/merge?showAll=false" class="btn btn-dark btn-sm">Masquer les égalités</a>
						</div>
					</h5>
				</p>
				<div th:each="diffDisplay, tstat : ${preparation.preparedContent}" th:id="${diffDisplay.dictionaryEntryUuid}">
					<div th:if="${!diffDisplay.diff.isEmpty() and (showAll or diffDisplay.diffNeedAction )}" class="dictionary-content" >
						<div class="dictionary-summary">
							<span class="dictionary-name" th:text="${diffDisplay.dictionaryEntryName}">Type de matériel</span>
							<span class="dictionary-details" th:text="|- table : ${diffDisplay.dictionaryEntryTableName} - Domaine : ${diffDisplay.domainName}|">Domaine : Gestion du matériel</span>&nbsp;
							<span class="dictionary-diff-size" th:text="|${diffDisplay.realDiffSize} valeur(s)|">15 valeurs</span>
							<span class="reducer reducer-table reducer-close float-right" title="afficher / masquer le détail pour la table de paramétrage">&nbsp;</span>
						</div>
						<table class="table table-sm">
							<thead>
								<tr>
									<th scope="col" width="15%">Clé (<span th:text="${diffDisplay.dictionaryEntryKeyName}">TITLE</span>)</th>
									<th scope="col" colspan="2" width="85%">
										<span th:if="${needsAction}">
											Modification
											<div class="btn-group float-right" role="group">
												<button type="button" th:id="|select_${diffDisplay.dictionaryEntryUuid}|" class="btn btn-outline-primary all-button btn-sm">Tout appliquer</button>
												<button type="button" th:id="|rollback_${diffDisplay.dictionaryEntryUuid}|" class="btn btn-outline-danger all-button btn-sm">Tout ignorer</button>
											</div>
										</span>
									</th>
								</tr>
							</thead>
							<tbody>
								<tr th:each="entry, estat : ${diffDisplay.diff}" th:id="|${tstat.index}_${estat.index}|" th:if="${showAll or entry.needAction}">
									<td th:if="${!entry.displayOnly}" th:text="${entry.keyValue}">XAZER5555 - 22</td>
									<td th:if="${entry.displayOnly}" class="similar-display" th:text="|${entry.keyValues.size()} entrées similaires|" th:title="|clées : ${entry.combinedKey}|">34 entrées similaires</td>
									<td width="72%">
										<span class="reducer reducer-sm reducer-open float-right">&nbsp;</span>
										<span class="change-details">
											<span class="change-title">Modification locale</span> : 
											<span th:if="${entry.mine}" th:class="|mine action-line ${#strings.toLowerCase(entry.mine.action.name())}|" class="action-add">
												<span class="change-display">
													<span class="action-display" th:text="${entry.mine.action.name()}=='ADD'?'Ajout':(${entry.mine.action.name()}=='REMOVE'?'Suppression':'Modification')">Ajout</span>
													<span th:if="${entry.mine.payload}" th:utext="${entry.mine.hrPayload}">"Compteur d'eau" / "abc" / "FS" => suppr</span>
													<span th:if="!${entry.mine.payload}"> - pas de détails - </span>
												</span>
											</span>
											<span class="mine change-display-none" th:if="!${entry.mine}">Ligne non présente dans l'index (ligne supprimée ou non créée)</span>
											<span class="change-title">Modification importée</span> : 
											<span th:if="${entry.their}" th:class="|their change-display action-line ${#strings.toLowerCase(entry.their.action.name())}|" class="action-add">
												<span class="change-display">
													<span class="action-display" th:text="${entry.their.action.name()}=='ADD'?'Ajout':(${entry.their.action.name()}=='REMOVE'?'Suppression':'Modification')">Ajout</span>
													<span th:if="${entry.their.payload}" th:utext="${entry.their.hrPayload}">"Compteur d'eau" / "abc" / "FS" => suppr</span>
													<span th:if="!${entry.their.payload}"> - pas de détails - </span>
												</span>
											</span>
											<span class="mine change-display-none" th:if="!${entry.their}">Non présente dans l'import</span>
											<span class="change-title">Proposition</span> : 
										</span>
										<span th:if="${entry.action}" th:class="|merged change-display action-line ${#strings.toLowerCase(entry.action.name())}|">
											<span class="change-display">
												<span class="action-display" th:text="${entry.action.name()}=='ADD'?'Ajout':(${entry.action.name()}=='REMOVE'?'Suppression':'Modification')">Ajout</span>
												<span th:if="${entry.payload}" th:utext="${entry.hrPayload}">"Compteur d'eau" / "abc" / "FS" => suppr</span>
												<span th:if="!${entry.payload}"> - pas de détails - </span>
											</span>
										</span>
										<span class="merged change-display-none" th:if="!${entry.action}">Modifications identiques, rien à changer</span>
									</td>
									<td th:if="${entry.needAction}">
										<input type="hidden" th:id="|selectFor${tstat.index}_${estat.index}|" th:field="${preparation.preparedContent[__${tstat.index}__].diff[__${estat.index}__].selected}"></input>
										<input type="hidden" th:id="|rollbackFor${tstat.index}_${estat.index}|" th:field="${preparation.preparedContent[__${tstat.index}__].diff[__${estat.index}__].rollbacked}"></input>
										<div class="btn-group float-right" role="group">
											<button type="button" th:class="${preparation.preparedContent[__${tstat.index}__].diff[__${estat.index}__].selected}?'btn btn-primary btn-sm select-button':'btn btn-outline-primary btn-sm select-button'" class="btn btn-primary btn-sm select-button">Appliquer</button>
											<button type="button" th:class="${preparation.preparedContent[__${tstat.index}__].diff[__${estat.index}__].rollbacked}?'btn btn-danger btn-sm rollback-button':'btn btn-outline-danger btn-sm rollback-button'" class="btn btn-danger btn-sm rollback-button">Ignorer</button>
										</div>
									</td>
									<td th:if="!${entry.needAction}">
										<button type="button" class="btn btn-secondary-outline btn-sm select-button float-right" disabled="disabled">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Déjà en place&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</button>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
				<p>
					<div class="float-right">
						<input type="submit" class="btn btn-success btn-sm" value="Confirmer les opérations"/><br/><br/>
					</div>
				</p>
			</span>
			<span th:if="${preparation.emptyDiff}">
				<p>
					<h5>Aucune nouvelle modification identifiée dans les données de paramètrage par rapport<br/> au contenu de l'import.
						<div class="float-right">
							<a th:href="@{/ui/merge/cancel}" href="#" class="btn btn-secondary btn-sm">Abandonner</a>
							<a th:href="@{/ui/pull}" href="#" class="btn btn-dark btn-sm">Retourner à l'import</a>
						</div>
					</h5>
				</p>
				<div class="alert alert-secondary" role="alert">
					<strong>La recherche de différences n'a identifié aucune nouvelle données de paramètrage par rapport au(x) lot(s) importé(s)</strong>. 
					Le traitement s'appuie sur les tables de paramètrage identifiées dans le dictionnaire, et recherche pour chacune les données actuellement 
					présentes. Il compart ensuite le résultat avec les données déjà stockées dans l'ensemble des lots de modifications présents, complétées
					par les données présentes dans le fichier importé, et recherche si des différences sont présentes. Il n'y a donc actuellement aucune
					différence identifiée : toutes les données de paramètrage ont été déjà validées dans des lots de modification (cela ne veut pas
					nécessairement dire que le fichier avait déjà été importé). 
				</div>
				<p>&nbsp;<br/><br/><br/><br/></p>
			</span>
		</form>
	</span>
    <script layout:fragment="script" th:inline="javascript">
		 /*<![CDATA[*/
		
        // When selecting
        const selectAction = (item) => {
			hideDisplays();
        	var selectInput = $("#selectFor" + item);
        	var rollbackInput = $("#rollbackFor" + item);
			if(selectInput.val() === 'false'){
				console.info("selected " + item);
				selectInput.val("true");
				rollbackInput.val("false");
				$("#" + item + " td button.select-button").removeClass("btn-outline-primary").addClass("btn-primary");
				$("#" + item + " td button.rollback-button").removeClass("btn-danger").addClass("btn-outline-danger");
			}
        };
        
        // When rollbacking
        const rollbackAction = (item) => {
			hideDisplays();
        	var selectInput = $("#selectFor" + item);
        	var rollbackInput = $("#rollbackFor" + item);
			if(rollbackInput.val() === 'false'){
				console.info("rollback " + item);
				selectInput.val("false");
				rollbackInput.val("true");
				$("#" + item + " td button.select-button").removeClass("btn-primary").addClass("btn-outline-primary");
				$("#" + item + " td button.rollback-button").removeClass("btn-outline-danger").addClass("btn-danger");
			}
        };
        
		// For table hidding
		const hideAndShowTableAction = (tableUuid) => {
			hideDisplays();
			var table = $("#" + tableUuid + " table");
			var button = $("#" + tableUuid + " span.reducer-table");
			if(button.attr("class").indexOf('reducer-close') !== -1){
				table.hide();
				button.removeClass("reducer-close").addClass("reducer-open");
			} else {
				table.show();
				button.removeClass("reducer-open").addClass("reducer-close");
			}
		};
		
		// For table hidding
		const hideAndShowDisplayAction = (trUuid) => {
			hideDisplays();
			var display = $("#" + trUuid + " span.change-details");
			var button = $("#" + trUuid + " span.reducer-sm");
			if(button.attr("class").indexOf('reducer-close') !== -1){
				display.hide();
				button.removeClass("reducer-close").addClass("reducer-open");
			} else {
				display.show();
				button.removeClass("reducer-open").addClass("reducer-close");
			}
		};
		
		// For hidding all
		const hideAndShowAllTablesAction = (force) => {
			$("span.reducer-table").each((index, e) => {
				var tableUuid = e.parentElement.parentElement.parentElement.id;
				var table = $("#" + tableUuid + " table");
				var button = $("#" + tableUuid + " span.reducer-table");
				if(force === 'hide'){
					table.hide();
					button.removeClass("reducer-close").addClass("reducer-open");
				} else {
					table.show();
					button.removeClass("reducer-open").addClass("reducer-close");
				}
			});
		};
		
		// For "select All / rollback All / ignore All"
		const processAll = (butId) => {
			var idParts = butId.split("_");
			console.log("All " + idParts[0] + " on table " + idParts[1]);
			$("#" + idParts[1] + " button." + idParts[0] + "-button").click();
		};
		
    	// Init actions
    	$(document).ready(() => {
			var defaultShow = /*[[${showAll}?'show':'hide']]*/ 'hide';
			hideAndShowAllTablesAction(defaultShow);
			$("span.change-details").hide();
			
			$("span.reducer-table").click((e) => hideAndShowTableAction(e.target.parentElement.parentElement.parentElement.id));
			$("span.reducer-sm").click((e) => hideAndShowDisplayAction(e.target.parentElement.parentElement.id));
			
			$("button.select-button").click((e) => selectAction(e.target.parentElement.parentElement.parentElement.id));
			$("button.rollback-button").click((e) => rollbackAction(e.target.parentElement.parentElement.parentElement.id));
			$("button.all-button").click((e) => processAll(e.target.id));
			$("#selectAllButton").click((e) => $("button.select-button").click());
			$("#rollbackAllButton").click((e) => $("button.rollback-button").click());
			$("#closeAllButton").click((e) => hideAndShowAllTablesAction('hide'));
			$("#showAllButton").click((e) => hideAndShowAllTablesAction('show'));
		}); 
		
        /*]]>*/
    </script>
</body>
</html>