import com.efluid.jenkinsfile.Jenkinsfile

// variables globales
node('socle-jenkins-maven-docker-14-4G'){
def credentialsId = env.credentialsId
git branch: env.BRANCH_NAME, credentialsId: credentialsId, url: 'https://github.com/efluid/datagate'

withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: credentials.httpProxyAuthentication, passwordVariable: 'proxyPassword', usernameVariable: 'proxyUsername']]) {
           env.HTTP_PROXY = "http://${env.proxyUsername}:${env.proxyPassword}@${variables.httpProxyHost}:${variables.httpProxyPort}"
           env.HTTPS_PROXY = "http://${env.proxyUsername}:${env.proxyPassword}@${variables.httpProxyHost}:${variables.httpProxyPort}"
}
try{
    def urlArtifactoryRelease = env.urlArtifactoryRelease
	def urlArtifactorySnapshot = env.urlArtifactorySnapshot
	def adressMailFrom = env.adressMailFrom
	def adressMailTo = env.adressMailTo
	sh 'mvn clean deploy -DskipTests=true -DurlArtifactoryRelease=${urlArtifactoryRelease} -DurlArtifactorySnapshot=${urlArtifactorySnapshot}'
	sh 'cp datagate-app/target/datagate-app-exec.jar datagate-app/src/docker/build-serv-efluid/standalone-with-h2'
	sh 'cp datagate-app/src/docker/build-serv-efluid/logback.xml datagate-app/src/docker/build-serv-efluid/standalone-with-h2'
	sh "docker build -t ${variables.artifactoryDockerRegistryAlias}/datagate datagate-app/src/docker/build-serv-efluid/standalone-with-h2"
	sh "docker push ${variables.artifactoryDockerRegistryAlias}/datagate"
} catch (Exception e) {
	mail bcc: '', body: """datagate en erreur

	${env.BUILD_URL}""", cc: '', from: adressMailFrom, replyTo: '', subject: 'Test datagate', to: adressMailTo
	throw e
}
}
return this;