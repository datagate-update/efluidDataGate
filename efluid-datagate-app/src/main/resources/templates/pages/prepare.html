<!DOCTYPE html>
<html layout:decorate="~{layouts/pages.html}">
<head>
</head>
<body>
	<span layout:fragment="content">
		<span th:if="${preparation.status.name()}=='FAILED'">
			<div class="alert alert-danger">
				<h4>La preparation du lot de modification a rencontré une erreur</h4>
				<div th:replace="layouts/commons::error-display (${preparation.errorDuringPreparation.error},${preparation.errorDuringPreparation.payload})">...</div>
				<span class="remark">
					La préparation implique une extraction de toutes les données des tables identifiées comme du paramétrage dans le dictionnaire. 
					En cas de soucis sur ces données, le processus peut ne pas aboutir. 
					Si nécessaire, merci de communiquer le code d'erreur suivant : <span th:text="|${preparation.errorDuringPreparation.error}-${preparation.errorDuringPreparation.timestamp}|">JSON_WRITE_ERROR-12414421224112</span>
				</span>
			</div>
			<a href="index.html" class="btn btn-secondary btn-sm" th:href="@{/ui/}">Revenir à la page d'accueil</a>
			<a th:href="@{/ui/prepare/restart}" href="#" class="btn btn-primary btn-sm">Recommencer</a>
			<a href="#" th:href="@{/ui/prepare/cancel}" class="btn btn-dark btn-sm">Annuler la préparation</a>
		</span>
		<form th:if="${preparation.status.name()}!='FAILED'" action="/commit.html" th:action="@{/ui/prepare/commit}" method="post">
			<div th:if="${not preparation.diffRemarks.empty}" class="alert alert-danger" role="alert">
				<div class="diff-remarks">
					<div id="diffRemarkAreaButton" class="reducer reducer-close float-right" title="afficher / masquer le détail pour la table de paramétrage">&nbsp;</div>
					<span><b>Des avertissements ont été identifiés suite à la recherche de différences :</b></span>
					<span id="diffRemarkArea">
						<ul th:each="remark, estat : ${preparation.diffRemarks}" th:id="|common_remark_${estat.index}|" th:switch="${remark.type.name()}">
							<li th:case="'MISSING_ON_UNCHECKED_JOIN'">
								La <span th:text="${remark.location}">table TABLE</span> possède un ou plusieurs liens vers d'autres tables, et des entités
								 référencées n'existent pas. Un total de <span th:text="${remark.payload.size()}">12</span> ligne(s) sont ainsi incorrectement remontées,
								 et sont actuellement ignorées dans le résultat. Dans certains cas, cela peut induire des identifications de modifications fausses
								 pour la <span th:text="${remark.location}">table TABLE</span>.<br/><u>Entrées manquantes identifiées</u> :
								 <ul>
								 	<li th:each="missing, mstat : ${remark.payload}" th:id="${mstat.index}">
								 		<span class="table-key" th:text="'Colonne ' + ${missing.getColumnName()}"></span> : <span th:text="${missing.key}" class="table-key">KEY</span>
									</li>
								 </ul>
							</li>
						</ul>
					</span>
				</div>
			</div> 
			<div th:if="${not preparation.emptyDiff}">
				<p>
					<h5>Ensemble des modifications identifiées
						<div class="float-right">
							<div class="btn-group" role="group">
								<button type="button" id="selectAllButton" class="btn btn-outline-primary btn-sm">Tout garder</button>
								<button type="button" id="rollbackAllButton" class="btn btn-outline-danger btn-sm">Tout annuler</button>
								<button type="button" id="ignoreAllButton"  class="btn btn-outline-secondary btn-sm">Tout ignorer</button>
							</div>&nbsp;
							<a th:href="@{/ui/prepare/cancel}" href="#" class="btn btn-secondary btn-sm">Abandonner</a>
							<a th:href="@{/ui/prepare/restart}" href="#" class="btn btn-dark btn-sm" type="button">Regénérer</a>
						</div>
					</h5>
				</p>
				<table class="table table-sm">
					<thead>
						<tr>
							<th scope="col" width="15%">Domaine</th>
							<th scope="col" width="15%">Table</th>
							<th scope="col" width="15%">Clé</th>
							<th scope="col" width="10%">Type</th>
							<th scope="col">Modification</th>
							<th scope="col" width="18%">&nbsp;</th>
						</tr>
					</thead>
					<tbody class="pageHolder">
						<tr id="searchBar">
			     			<td colspan="100%">
			     				<div>
								    <input id="searchField" type="text" class="form-control float-left" name="search" style="width:400px!important;display:inline-block;height:31px;margin-right:10px" size="50" placeholder="Filtre"/>
								    <button id="filterButton" type="button" class="btn btn-outline-success btn-sm float-left">Filtrer par clés</button>
								    <button id="resetButton" type="button" class="btn btn-outline-secondary btn-sm float-left" disabled="disabled" style="margin-left:5px!important">Tout lister</button>
								</div>
							</td>
			     		</tr>
						<tr id="navBar">
							<td colspan="100%"><div id="navBarContent"></div></td>
						</tr>
					</tbody>
				</table>
				<p>
					<div class="float-right">
						<input type="submit" class="btn btn-success btn-sm" value="Confirmer les opérations"/><br/><br/>
					</div>
				</p>
			</div>
			<div th:if="${preparation.emptyDiff}">
				<p>
					<h5>Aucune nouvelle modification identifiée dans les données de paramètrage.
						<div class="float-right">
							<a th:href="@{/ui/prepare/cancel}" href="#" class="btn btn-secondary btn-sm">Abandonner</a>
							<a th:href="@{/ui/prepare/restart}" href="#" class="btn btn-dark btn-sm">Rafraichir les modifications</a>
						</div>
					</h5>
				</p>
				<div class="alert alert-secondary" role="alert">
					<strong>La recherche de différences n'a identifié aucune nouvelle données de paramètrage</strong>. Le traitement s'appuie sur les tables de paramètrage
					identifiées dans le dictionnaire, et recherche pour chacune les données actuellement présentes. Il compart ensuite le résultat avec les données déjà
					stockées dans l'ensemble des lots de modifications présents, et recherche si des différences sont présentes. Il n'y a donc actuellement aucune différence
					identifiée : toutes les données de paramètrage ont été déjà validées dans des lots de modification.
				</div>
				<p>&nbsp;<br/><br/><br/><br/></p>
			</div>
		</form>
	</span>
    <script layout:fragment="script" th:inline="javascript">
		 /*<![CDATA[*/

		/* For pagination */

		$('#color-nav-2').css("font-weight", "bold");

		const updateSelectItem = (index, selected, rollbacked) => {

			$.post("/ui/prepare/selection/line/" + index + "?selected="+ selected + "&rollbacked=" + rollbacked, null, (data, status) => {
				
				// Reset 3 buttons
				$("#" + index + "_item button.select-button").removeClass("btn-primary").addClass("btn-outline-primary");
				$("#" + index + "_item button.rollback-button").removeClass("btn-danger").addClass("btn-outline-danger");
				$("#" + index + "_item button.ignore-button").removeClass("btn-outline").addClass("btn-outline-secondary");
				
				// Apply selected button
				if(selected){
					$("#" + index + "_item button.select-button").removeClass("btn-outline-primary").addClass("btn-primary");
				} else if(rollbacked) {
					$("#" + index + "_item button.rollback-button").removeClass("btn-outline-danger").addClass("btn-danger");
				} else {
					$("#" + index + "_item button.ignore-button").removeClass("btn-outline-secondary").addClass("btn-secondary");
				}
			});
		};
		
		const createNavBarItem = (active, num) => {
			return '<li class="page-item' + (active ? ' active' : '') + '"><a class="page-link" style='+ (active ? 'color:#ffffff' : 'color:#007bff') + ' onclick="getPageContent(' + num + ')">' + (num + 1) + '</a></li>';
		};

		const createNavBarPrevious = (num) => {
			return '<li class="page-item"><a class="page-link" style=color:#007bff onclick="getPageContent(' + num + ')">Précédent</a></li>';
		};

		const createNavBarNext = (num) => {
			return '<li class="page-item"><a class="page-link" style=color:#007bff onclick="getPageContent(' + num + ')">Suivant</a></li>';
		};
		
		const displayNavBar = (pageIndex, pageCount) => {
			
			var navBar = '<nav aria-label="navbar"><ul class="pagination">';

			var splitOneStart = -1;
			var splitOneEnd = -1;
			var splitTwoStart = -1 ;
			var splitTwoEnd = -1 ;

			// Intermediate "split" in navBar depending on current pos and size
			if (pageCount >= 8) {

				// Current at the beginning : 1 spacer
				if (pageIndex < 4) {
					splitOneStart = 4;
					splitOneEnd = pageCount - 3;
				}

				// Current at the end : 1 spacer
				else if (pageIndex > pageCount - 5) {
					splitOneStart = 2;
					splitOneEnd = pageCount - 5;
				}

				// Current elsewhere : 2 spacers around
				else {
					splitOneStart = 2;
					splitOneEnd = pageIndex - 2;
					splitTwoStart = pageIndex + 2;
					splitTwoEnd = pageCount - 3;
				}
			}

			if(pageIndex > 0){
				navBar += createNavBarPrevious(pageIndex-1);
			}

			for(i = 0; i < pageCount; i++) {
				// First optional split
				if(i >= splitOneStart && i < splitOneEnd){
					i = splitOneEnd;
					navBar += '<li class="page-item disabled"><a class="page-link" href=""><span>...</span></a></li>';
				} else if(i >= splitTwoStart && i < splitTwoEnd){
					i = splitTwoEnd;
					navBar += '<li class="page-item disabled"><a class="page-link" href=""><span>...</span></a></li>';
				} else {
					navBar += createNavBarItem(i == pageIndex, i);
				}
			}

			if(pageIndex < pageCount){
				navBar += createNavBarNext(pageIndex+1);
			}

			return navBar + '</ul></nav>';
		};
		
		const getPageContent = (page) => {

			var searchField = $("#searchField");
			var search = searchField.val();

			var resetButton = $("#resetButton");
			
			if(search !== ''){
				resetButton.prop('disabled', false);
			} else {
				resetButton.prop('disabled', true);
			}

			$.get("/ui/prepare/page/" + page + "?search=" + search, (data, status) => {
				
				// Remove current page
				$(".added-item").remove();
				
				var navBar = $("#navBar");
				
				// Put new items
				data.page.forEach(e => {
				
					var keyDisplay = e.displayOnly ? e.keyValues.length + 'entrées similaires' : e.keyValue;
					var keyTitle = e.displayOnly ? 'clées : ' + e.combinedKey : 'clée : ' + e.keyValue;
					var actionDisplay = e.action === 'ADD' ? 'Ajout' : e.action === 'REMOVE' ? 'Suppression' : 'Modification';
				
					var butSelecClass = e.selected ? 'btn btn-primary btn-sm select-button' : 'btn btn-outline-primary btn-sm select-button';
					var butRollbackClass = e.rollbacked ? 'btn btn-danger btn-sm rollback-button' : 'btn btn-outline-danger btn-sm rollback-button';
					var butIgnoreClass = !(e.selected || e.rollbacked) ? 'btn btn-secondary btn-sm ignore-button' : 'btn btn-outline-secondary btn-sm ignore-button';

					var hrPayload = e.hrPayload ? e.hrPayload : " - Vide - ";
				
					var itemRow = 
						'<tr id="' + e.indexForDiff + '_item" class="action-line ' + e.action.toLowerCase() + ' added-item">' +
							'<td>' + e.domainName + '</td>' +
							'<td>' + e.tableName + '</td>' +
						 	'<td title="' + keyTitle + '">' + keyDisplay + '</td>' +
						 	'<td class="action-display">' + actionDisplay + '</td>' +
						 	'<td><span class="change-display" title="payload technique=' + e.payload + '">' + hrPayload + '</span></td>' +
						 	'<td>' +
							 	'<div class="btn-group float-right" role="group">' +
									'<button type="button" class="' + butSelecClass + '" onclick="updateSelectItem(\'' +  e.indexForDiff + '\',true,false)">Garder</button>' +
									'<button type="button" class="' + butRollbackClass + '" onclick="updateSelectItem(\'' +  e.indexForDiff + '\',false,true)">Annuler</button>' +
									'<button type="button" class="' + butIgnoreClass + '" onclick="updateSelectItem(\'' +  e.indexForDiff + '\',false,false)">Ignorer</button>' +
								'</div>' +
							'</td>' +
						'</tr>';
							
					 navBar.before(itemRow);
				}); 
				
				// Update navBar displayNavBar
				if(data.pageCount > 1){
					$("#navBarContent").html(displayNavBar(data.pageIndex, data.pageCount));
				} else {
					$("#navBarContent").html("");
				}
		    });
		};

		const filterPageData = () => {
			getPageContent(0);
		};
		
		const resetFilterPageData = () => {
			var searchField = $("#searchField");
			searchField.val('');
			getPageContent(0);
		};
		
		/* End pagination */
		        
		// For remarks hidding
		const hideAndShowDiffRemarksAction = () => {
			hideDisplays();
			var area = $("#diffRemarkArea");
			var button = $("#diffRemarkAreaButton");
			if(button.attr("class").indexOf('reducer-close') !== -1){
				area.hide();
				button.removeClass("reducer-close").addClass("reducer-open");
			} else {
				area.show();
				button.removeClass("reducer-open").addClass("reducer-close");
			}
		};

		// For "select All / rollback All / ignore All"
		const processAll = (type) => {
			
			var selected = type === "select";
			var rollbacked = type === "rollback";

			$.post("/ui/prepare/selection/all?selected="+ selected + "&rollbacked=" + rollbacked, null);

				if(selected){
					$("button.select-button").click();
				} else if(rollbacked){
					$("button.rollback-button").click();
				} else {
					$("button.ignore-button").click();
				}

		};
		
    	// Init actions
    	$(document).ready(() => {
			getPageContent(0);
			$("#selectAllButton").click((e) => processAll('select'));
			$("#rollbackAllButton").click((e) => processAll('rollback'));
			$("#ignoreAllButton").click((e) => processAll('ignore'));
			$("#diffRemarkAreaButton").click((e) => hideAndShowDiffRemarksAction());
			$("#filterButton").click(() => filterPageData());
			$("#resetButton").click(() => resetFilterPageData());
		}); 
		
        /*]]>*/
    </script>
</body>
</html>